<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Bloques - Sin Marcadores (Actualizado 2025)</title>
  <style>
    body{margin:0;overflow:hidden;font-family:Arial,sans-serif;touch-action:manipulation;background:#000;}
    .controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,.95);padding:15px 20px;border-radius:15px;text-align:center;backdrop-filter:blur(10px);box-shadow:0 4px 20px rgba(0,0,0,.3);}
    button{margin:5px;padding:12px 16px;font-size:16px;border:none;border-radius:8px;background:linear-gradient(45deg,#3498db,#2980b9);color:#fff;cursor:pointer;min-width:120px;touch-action:manipulation;transition:.3s;box-shadow:0 2px 10px rgba(52,152,219,.3);}
    button:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(52,152,219,.4);}
    button:active{transform:translateY(0);background:linear-gradient(45deg,#2980b9,#1f5f8b);}
    button.danger{background:linear-gradient(45deg,#e74c3c,#c0392b);box-shadow:0 2px 10px rgba(231,76,60,.3);}
    button.danger:hover{box-shadow:0 4px 15px rgba(231,76,60,.4);}
    .info-panel{position:fixed;top:20px;right:20px;background:rgba(0,0,0,.8);color:#fff;padding:20px;border-radius:15px;width:320px;max-width:calc(100vw - 40px);z-index:1000;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);}
    .ar-status{position:fixed;top:20px;left:20px;background:rgba(0,255,0,.8);color:#000;padding:10px 15px;border-radius:20px;z-index:1000;font-weight:bold;backdrop-filter:blur(5px);}
    .ar-status.searching{background:rgba(255,165,0,.8);color:#000;}
    .ar-status.error{background:rgba(255,0,0,.8);color:#fff;}
    @media(max-width:768px){
      .info-panel{top:10px;left:10px;right:10px;width:auto;max-height:30vh;overflow-y:auto;}
      .controls{bottom:10px;left:10px;right:10px;transform:none;width:auto;flex-wrap:wrap;display:flex;justify-content:center;}
      button{flex:1;min-width:100px;margin:3px;}
    }
    #loadingStatus{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;padding:30px;border-radius:15px;z-index:2000;text-align:center;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);}
    .loading-spinner{border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top:3px solid #3498db;width:30px;height:30px;animation:spin 1s linear infinite;margin:10px auto;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .permissions-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:3000;backdrop-filter:blur(5px);}
    .permissions-content{background:#fff;padding:30px;border-radius:15px;text-align:center;max-width:400px;margin:20px;}
    .permissions-content h2{color:#2c3e50;margin-bottom:20px;}
    .permissions-content p{color:#7f8c8d;line-height:1.5;margin-bottom:20px;}
  </style>
</head>
<body>
  <div id="permissionsModal" class="permissions-modal" style="display: none;">
    <div class="permissions-content">
      <h2>üé• Permisos de C√°mara</h2>
      <p>Esta aplicaci√≥n necesita acceso a tu c√°mara para crear la experiencia de Realidad Aumentada sin marcadores.</p>
      <button onclick="requestCameraPermission()">Permitir C√°mara</button>
    </div>
  </div>
  <div id="loadingStatus">
    <div class="loading-spinner"></div>
    <div>Inicializando AR sin marcadores...</div>
  </div>
  <div id="arStatus" class="ar-status searching">üîç Buscando superficies...</div>
  <a-scene id="arScene" style="display:none;" embedded arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;" vr-mode-ui="enabled: false" gesture-detector>
    <a-camera id="arCamera" gps-camera="minDistance: 5; maxDistance: 100;" look-controls="enabled: false" wasd-controls="enabled: false" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .interactable; far: 50;"></a-camera>
    <a-entity id="arrayContainer" position="0 -1 -3" rotation="0 0 0">
      <a-entity id="array"></a-entity>
    </a-entity>
    <a-plane id="groundPlane" position="0 -2 -3" rotation="-90 0 0" width="10" height="10" color="transparent" material="transparent: true; opacity: 0;"></a-plane>
    <a-light type="ambient" color="#404040" intensity="1.2"></a-light>
    <a-light type="directional" position="2 4 1" color="#fff" intensity="1" castShadow="true"></a-light>
    <a-light type="point" position="0 2 0" color="#fff" intensity="0.5"></a-light>
  </a-scene>
  <div class="controls">
    <button onclick="contarBloques()">üìä Contar Bloques</button>
    <button onclick="moverBloques()">üéØ Reorganizar</button>
    <button onclick="cambiarVista()">üëÅÔ∏è Cambiar Vista</button>
    <button onclick="resetearBloques()" class="danger">üîÑ Resetear</button>
  </div>
  <div class="info-panel">
    <h3>üöÄ AR sin Marcadores</h3>
    <pre id="infoDisplay">Inicializando sistema...</pre>
  </div>
  <!-- √öltimas versiones de A-Frame y AR.js (2025) -->
   <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>
  <script>
    // Variables globales
    let arrayEntity;
    let bloques = [];
    let selectedBlock = null;
    let isInitialized = false;
    let arMode = 'surface'; // 'surface', 'fixed', 'floating'
    let surfaceDetected = false;
    let cameraPermissionGranted = false;
    const colores = [
      '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
      '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
    ];

    // Verificar soporte de dispositivo
    function checkDeviceSupport() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
      const hasWebRTC = !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
      return { isMobile, hasCamera, hasWebRTC, isSupported: hasCamera || hasWebRTC };
    }

    // Solicitar permisos de c√°mara
    async function requestCameraPermission() {
      try {
        document.getElementById('permissionsModal').style.display = 'none';
        document.getElementById('loadingStatus').style.display = 'block';
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
        });
        stream.getTracks().forEach(track => track.stop());
        cameraPermissionGranted = true;
        initializeAR();
      } catch (error) {
        console.error('Error accediendo a la c√°mara:', error);
        document.getElementById('loadingStatus').innerHTML = 
          '<div style="color: #e74c3c;">‚ùå Error de C√°mara</div><div>Verifica permisos y recarga la p√°gina</div>';
      }
    }

    // Verificar carga de scripts SOLO AFRAME
    function checkScriptsLoaded() {
      return typeof AFRAME !== 'undefined';
    }

    // Inicializar AR sin marcadores
    function initializeAR() {
      console.log('üöÄ Inicializando AR sin marcadores...');
      if (!checkScriptsLoaded()) {
        setTimeout(initializeAR, 300);
        return;
      }
      try {
        // Componente detector de gestos para AR sin marcadores
        AFRAME.registerComponent('gesture-detector', {
          init: function () {
            this.el.addEventListener('touchstart', this.onTouchStart.bind(this));
            this.el.addEventListener('touchend', this.onTouchEnd.bind(this));
            this.el.addEventListener('click', this.onClick.bind(this));
            // Superficie detectada INMEDIATAMENTE
            surfaceDetected = true;
            document.getElementById('arStatus').textContent = '‚úÖ Superficie detectada';
            document.getElementById('arStatus').className = 'ar-status';
            this.showBlocks();
          },
          onTouchStart: function(event) {
            if (event.touches.length === 1) {
              const touch = event.touches[0];
              this.handleInteraction(touch.clientX, touch.clientY);
            }
            event.preventDefault();
          },
          onClick: function(event) {
            this.handleInteraction(event.clientX, event.clientY);
          },
          onTouchEnd: function(event) {
            event.preventDefault();
          },
          handleInteraction: function(x, y) {
            const camera = document.getElementById('arCamera');
            const raycaster = camera.components.raycaster;
            if (raycaster) {
              const intersections = raycaster.intersectedEls;
              if (intersections.length > 0) {
                const targetEl = intersections[0];
                if (targetEl.classList.contains('interactable')) {
                  this.selectBlock(targetEl);
                }
              }
            }
          },
          selectBlock: function(blockEl) {
            if (selectedBlock) {
              const prevComponent = selectedBlock.components['touch-interactive'];
              if (prevComponent) {
                selectedBlock.setAttribute('color', prevComponent.originalColor);
                selectedBlock.setAttribute('scale', prevComponent.originalScale);
              }
            }
            selectedBlock = blockEl;
            const component = blockEl.components['touch-interactive'];
            if (component) {
              blockEl.setAttribute('color', '#ff0000');
              blockEl.setAttribute('scale', '1.3 1.3 1.3');
              const label = blockEl.querySelector('a-text');
              const value = label ? label.getAttribute('value') : 'N/A';
              const pos = blockEl.getAttribute('position');
              updateInfoDisplay(`üéØ BLOQUE SELECCIONADO: ${value}
Posici√≥n: (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})
Estado: ACTIVO
Modo AR: Sin marcadores`);
            }
            setTimeout(() => {
              if (selectedBlock === blockEl && component) {
                blockEl.setAttribute('color', component.originalColor);
                blockEl.setAttribute('scale', component.originalScale);
                selectedBlock = null;
                updateInfoDisplay('Sistema listo. Toca un bloque para interactuar.');
              }
            }, 3000);
          },
          showBlocks: function() {
            if (!isInitialized) {
              crearBloques();
              isInitialized = true;
            }
          }
        });

        // Componente de interactividad para bloques
        AFRAME.registerComponent('touch-interactive', {
          init: function () {
            this.originalColor = this.el.getAttribute('color');
            this.originalScale = this.el.getAttribute('scale') || {x: 1, y: 1, z: 1};
            this.el.addEventListener('mouseenter', () => {
              if (!selectedBlock || selectedBlock === this.el) {
                this.el.setAttribute('scale', '1.1 1.1 1.1');
              }
            });
            this.el.addEventListener('mouseleave', () => {
              if (!selectedBlock || selectedBlock === this.el) {
                this.el.setAttribute('scale', this.originalScale);
              }
            });
          }
        });

        // Mostrar escena
        document.getElementById('arScene').style.display = 'block';
        document.getElementById('loadingStatus').style.display = 'none';
        arrayEntity = document.getElementById('array');

        updateInfoDisplay(`üéØ AR SIN MARCADORES ACTIVO
Modo: Detecci√≥n de superficie
Estado: Buscando plano horizontal
Dispositivo: ${checkDeviceSupport().isMobile ? 'M√≥vil' : 'Desktop'}

Instrucciones:
‚Ä¢ Mueve el dispositivo lentamente
‚Ä¢ Apunta a superficies planas
‚Ä¢ Los bloques aparecer√°n autom√°ticamente`);
      } catch (error) {
        console.error('‚ùå Error inicializando AR:', error);
        document.getElementById('arStatus').textContent = '‚ùå Error de inicializaci√≥n';
        document.getElementById('arStatus').className = 'ar-status error';
      }
    }

    function crearBloques() {
      if (!arrayEntity) return;
      while (arrayEntity.firstChild) { arrayEntity.removeChild(arrayEntity.firstChild); }
      bloques = [];
      const configuraciones = [
        ...Array(5).fill(0).map((_, i) => ({ x: (i - 2) * 1.5, y: 0, z: 0 })),
        ...Array(3).fill(0).map((_, i) => ({ x: (i - 1) * 1.5, y: 0, z: -1.5 })),
        ...Array(2).fill(0).map((_, i) => ({ x: (i - 0.5) * 3, y: 1.5, z: 0.5 }))
      ];
      configuraciones.forEach((config, i) => {
        const box = document.createElement('a-box');
        box.setAttribute('position', `${config.x} ${config.y} ${config.z}`);
        box.setAttribute('width', '0.8');
        box.setAttribute('height', '0.8');
        box.setAttribute('depth', '0.8');
        box.setAttribute('color', colores[i % colores.length]);
        box.setAttribute('class', 'interactable');
        box.setAttribute('touch-interactive', '');
        box.setAttribute('shadow', 'cast: true; receive: true');
        box.setAttribute('animation__spawn', {
          property: 'scale',
          from: '0 0 0',
          to: '1 1 1',
          dur: 800,
          delay: i * 150,
          easing: 'easeOutBounce'
        });
        box.setAttribute('animation__rotate', {
          property: 'rotation',
          from: '0 0 0',
          to: '0 360 0',
          dur: 20000,
          loop: true,
          easing: 'linear'
        });
        const label = document.createElement('a-text');
        label.setAttribute('value', i.toString());
        label.setAttribute('position', '0 -0.5 0.41');
        label.setAttribute('align', 'center');
        label.setAttribute('color', '#ffffff');
        label.setAttribute('width', '8');
        label.setAttribute('font', 'roboto');
        box.appendChild(label);
        arrayEntity.appendChild(box);
        bloques.push(box);
      });
      updateInfoDisplay(`‚úÖ BLOQUES CREADOS: ${bloques.length}
Configuraci√≥n: 3D din√°mico
Posicionamiento: Autom√°tico
Estado: Interactivos

üéÆ Controles disponibles:
‚Ä¢ Tocar bloque = Seleccionar
‚Ä¢ Contar = An√°lisis de posici√≥n  
‚Ä¢ Reorganizar = Nueva distribuci√≥n
‚Ä¢ Cambiar Vista = Modo diferente`);
    }

    function contarBloques() {
      if (!isInitialized) {
        updateInfoDisplay('‚ùå Sistema no inicializado');
        return;
      }
      const bloquesArray = document.querySelectorAll('#array a-box');
      const areas = { central: [], elevados: [], traseros: [], laterales: [] };
      bloquesArray.forEach((bloque, index) => {
        const pos = bloque.getAttribute('position');
        if (Math.abs(pos.x) < 1.5 && Math.abs(pos.z) < 1) {
          areas.central.push({index, pos});
        } else if (pos.y > 1) {
          areas.elevados.push({index, pos});
        } else if (pos.z < -1) {
          areas.traseros.push({index, pos});
        } else {
          areas.laterales.push({index, pos});
        }
        let color;
        if (areas.central.some(b => b.index === index)) color = '#00ff00';
        else if (areas.elevados.some(b => b.index === index)) color = '#00bfff';
        else if (areas.traseros.some(b => b.index === index)) color = '#ff8c00';
        else color = '#ff69b4';
        bloque.setAttribute('animation__highlight', {
          property: 'color',
          from: bloque.getAttribute('color'),
          to: color,
          dur: 1500,
          direction: 'alternate',
          loop: 3
        });
      });
      const mensaje = `üìä AN√ÅLISIS ESPACIAL COMPLETADO

üéØ √ÅREA CENTRAL: ${areas.central.length} bloques
üöÅ √ÅREA ELEVADA: ${areas.elevados.length} bloques  
üì¶ √ÅREA TRASERA: ${areas.traseros.length} bloques
üìç √ÅREAS LATERALES: ${areas.laterales.length} bloques

üìà TOTAL ANALIZADO: ${bloquesArray.length} bloques
üé® C√ìDIGO DE COLORES:
  üü¢ Central  üîµ Elevado  üü† Trasero  üü£ Lateral

‚úÖ AN√ÅLISIS: COMPLETADO`;
      updateInfoDisplay(mensaje);
    }

    function moverBloques() {
      if (!isInitialized) return;
      bloques.forEach((bloque, i) => {
        const newPos = {
          x: (Math.random() - 0.5) * 6,
          y: Math.random() * 2,
          z: (Math.random() - 0.5) * 4
        };
        bloque.setAttribute('animation__move', {
          property: 'position',
          to: `${newPos.x} ${newPos.y} ${newPos.z}`,
          dur: 2000,
          delay: i * 200,
          easing: 'easeInOutQuad'
        });
      });
      updateInfoDisplay('üéØ REORGANIZANDO BLOQUES...\nNuevas posiciones generadas\nAnimaci√≥n en progreso');
    }

    function cambiarVista() {
      const container = document.getElementById('arrayContainer');
      const currentPos = container.getAttribute('position');
      const vistas = [
        { pos: '0 -1 -3', rot: '0 0 0', name: 'Vista Frontal' },
        { pos: '3 0 -2', rot: '0 -45 0', name: 'Vista Lateral' },
        { pos: '0 2 -4', rot: '-15 0 0', name: 'Vista Superior' },
        { pos: '-2 0 -2', rot: '0 45 0', name: 'Vista Diagonal' }
      ];
      const currentIndex = vistas.findIndex(v => v.pos === `${currentPos.x} ${currentPos.y} ${currentPos.z}`);
      const nextIndex = (currentIndex + 1) % vistas.length;
      const nextVista = vistas[nextIndex];
      container.setAttribute('animation__viewchange', {
        property: 'position',
        to: nextVista.pos,
        dur: 1500,
        easing: 'easeInOutCubic'
      });
      container.setAttribute('animation__rotation', {
        property: 'rotation',
        to: nextVista.rot,
        dur: 1500,
        easing: 'easeInOutCubic'
      });
      updateInfoDisplay(`üëÅÔ∏è CAMBIANDO VISTA
Nueva perspectiva: ${nextVista.name}
Transici√≥n suave activada
Duraci√≥n: 1.5 segundos`);
    }

    function resetearBloques() {
      if (!isInitialized) return;
      selectedBlock = null;
      updateInfoDisplay('üîÑ REINICIANDO SISTEMA...');
      bloques.forEach((bloque, i) => {
        if (bloque.parentNode) {
          bloque.setAttribute('animation__explode', {
            property: 'position',
            to: `${(Math.random()-0.5)*20} ${Math.random()*10} ${(Math.random()-0.5)*20}`,
            dur: 1000,
            delay: i * 100,
            easing: 'easeInQuad'
          });
          bloque.setAttribute('animation__shrink', {
            property: 'scale',
            to: '0 0 0',
            dur: 1000,
            delay: i * 100
          });
        }
      });
      setTimeout(() => {
        crearBloques();
      }, 2000);
    }

    function updateInfoDisplay(message) {
      document.getElementById('infoDisplay').textContent = message;
    }

    // Inicializaci√≥n principal
    function startApp() {
      const deviceSupport = checkDeviceSupport();
      if (!deviceSupport.isSupported) {
        document.getElementById('loadingStatus').innerHTML = 
          '<div style="color: #e74c3c;">‚ùå Dispositivo no compatible</div><div>Se requiere c√°mara web para AR</div>';
        return;
      }
      if (deviceSupport.hasCamera && !cameraPermissionGranted) {
        document.getElementById('loadingStatus').style.display = 'none';
        document.getElementById('permissionsModal').style.display = 'flex';
      } else {
        initializeAR();
      }
    }

    // Event listeners
    window.addEventListener('error', function(e) {
      console.error('Error global:', e.error);
      document.getElementById('arStatus').textContent = '‚ùå Error del sistema';
      document.getElementById('arStatus').className = 'ar-status error';
    });

    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        if (isInitialized) { location.reload(); }
      }, 500);
    });

    // Inicializar cuando est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
  </script>
</body>
</html>
